#!/bin/sh
# Pre-push hook - Archives old files and updates documentation before pushing

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸš€ Fernhill Community - Pre-Push Checks"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Step 1: Archive old/duplicate files (dry run first to show what would happen)
echo ""
echo "ğŸ“¦ Step 1: Checking for files to archive..."
node scripts/archive.js 2>/dev/null

# If there are files to archive, run the actual archive
if [ $? -eq 0 ]; then
  # Check if user wants to auto-archive (can be skipped with SKIP_ARCHIVE=1)
  if [ "$SKIP_ARCHIVE" != "1" ]; then
    # Archive the files
    node scripts/archive.js --run 2>/dev/null
    
    # If files were archived, inform the user
    if [ -d ".archive" ]; then
      echo "  â„¹ï¸  Archived files moved to .archive/"
    fi
  else
    echo "  â­ï¸  Skipping archive (SKIP_ARCHIVE=1)"
  fi
fi

# Step 2: Run the documentation generator
echo ""
echo "ğŸ“ Step 2: Updating documentation..."
node scripts/update-docs.js

# Stage any updated docs
git add docs/ README.md 2>/dev/null

# Check if there are staged changes
if git diff --cached --quiet; then
  echo "  âœ… No documentation changes to commit"
else
  echo "  ğŸ“ Committing documentation updates..."
  git commit --amend --no-edit 2>/dev/null || git commit -m "docs: auto-update documentation [skip ci]"
fi

# Step 3: Quick TypeScript check (optional, can be slow)
if [ "$SKIP_TS_CHECK" != "1" ]; then
  echo ""
  echo "ğŸ” Step 3: Quick TypeScript check..."
  npx tsc --noEmit --skipLibCheck 2>/dev/null
  if [ $? -ne 0 ]; then
    echo "  âš ï¸  TypeScript has errors (push will continue)"
  else
    echo "  âœ… TypeScript OK"
  fi
else
  echo ""
  echo "â­ï¸  Step 3: Skipping TypeScript check (SKIP_TS_CHECK=1)"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  âœ… Pre-push complete - Ready to push!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

exit 0
